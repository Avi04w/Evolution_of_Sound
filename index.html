<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Evolution of Sound</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/bubble.css">
    <link rel="stylesheet" href="css/record_player.css">
    <link rel="stylesheet" href="css/treemap.css">
    <link rel="stylesheet" href="css/eras.css">
    <link rel="stylesheet" href="css/feature_timeline.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

</head>
<body>

<!-- Persistent top-left feature control (presentational only, not wired up) -->
<div id="persistent-feature-control" class="hidden">
    <div id="persistent-feature-panel" role="dialog" aria-modal="false" aria-label="Feature options">
        <label for="persistent-feature-select" style="font-size: 15px">Select Feature: </label>
        <select id="persistent-feature-select" aria-label="Select musical feature (persistent control)">
            <option value="acousticness">Acousticness</option>
            <option value="danceability">Danceability</option>
            <option value="energy">Energy</option>
            <option value="loudness">Loudness</option>
            <option value="speechiness">Speechiness</option>
            <option value="tempo">Tempo</option>
            <option value="valence">Valence</option>
        </select>
    </div>
</div>

<!-- single scroll container -->
<div class="pageScroller">

    <div id="scroll-hint">â†“ Scroll to explore â†“</div>

    <!-- Bubble Universe Visualization -->
    <section class="vis-section snap" id="bubble-section">
        <div id="bubble-viz-container" class="chart-space">
            <svg id="bubble-viz"></svg>
            <div id="bubble-tooltip" class="bubble-tooltip"></div>
        </div>
    </section>

    <!-- ðŸŽµ Vinyl Record Player Visualization -->
    <section>
        <div id="record-player-container" class="chart-space" style="display:none;">
            <div id="record-player-shell-out">
                <div id="record-player-shell-mid">
                    <div id="record-player-shell-in">
                        <div id="record-player-image-container">
                            <img id="record-player-image" style="display:none;" src="" alt="Record player" class="unselectable" />
                            <div id="record-player-pause" class="unselectable"><span></span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="record-player-arm"></div>
        </div>
        <audio id="player"></audio>
    </section>

    <section class="snap vis-section" id="era-section">
        <div class="era-heading">
            <h2 class="era-title-main">Most Popular Genres Every Five Years</h2>
            <p class="era-title-sub">billboard top-chart data grouped into 5-year eras</p>
        </div>
        <div class="era-layout">
            <div class="era-nav-wrap">
                <svg id="era-nav" width="200" height="520"></svg>
            </div>

            <div id="era-panels" class="era-panels"></div>
        </div>
    </section>

    <!-- Feature selection / Intro section -->
    <section class="vis-section snap" id="feature-selection-section">
        <div class="intro-container">
            <h2 class="intro-title">The Evolution of Sound</h2>
            <p class="intro-paragraph">
                <span>
                    Over the past four decades, popular music has evolved dramatically, shifting in energy, rhythm, mood, and tone.
                    This project visualizes those changes using interactive charts built from Spotify and Billboard data.
                </span>
                <br>
                <span>
                    Scroll to explore how key musical features evolve over time.
                </span>
                <br>
                <span style="font-weight: 500;">
                    You can also click any song to listen using the Spotify player at the bottom right.
                </span>
            </p>

            <hr class="intro-divider">

            <h3 class="feature-section-title" style="margin-bottom: 0;">Musical Features</h3>
            <p class="feature-section-subtitle" style="margin: 10px 0;">
                Each feature captures a different aspect of a songâ€™s composition and feel. Change the selected feature at the top left of the page.
            </p>

            <!-- Feature selector and detailed description -->
            <div id="feature-description" >
                <!-- Detailed feature description populated by script -->
            </div>
        </div>
    </section>

    <!-- DNA Helix Visualization Section -->
    <section class="vis-section snap" id="dna-section">
        <div class="text-block">
            <h3>The DNA of Music</h3>
        </div>
        <div id="vis-dna" class="chart-space"></div>
        <div id="vis-dna-yearly" class="chart-space" style="display:none">
        </div>
    </section>

    <!-- Universe -->
    <section class="vis-section snap" id="universe-section">
        <iframe src="universe.html" title="Music Universe - Interactive Visualization" loading="lazy" class="universe-embed" allowfullscreen></iframe>
    </section>

    <!-- Geographical Explorer -->
    <section class="vis-section snap" id="geo-section">
        <iframe
            src="viz-globalization/index.html"
            title="Global Billboard Origins Prototype"
            loading="lazy"
            class="geographical-embed"
            allowfullscreen
        ></iframe>
    </section>

<!--    &lt;!&ndash; Genre Treemap &ndash;&gt;-->
<!--    <section class="vis-section snap" id="genre-section">-->
<!--        <div class="chart-container">-->
<!--            <h2 class="chart-title">How Genres Defined Each Yearâ€™s Music Scene</h2>-->
<!--            <p class="chart-description">A treemap showing how dominant music genres shaped the charts each year.</p>-->
<!--            <div id="treemap" class="chart-space"></div>-->
<!--        </div>-->
<!--    </section>-->

    <section class="vis-section snap" id="feature-timeline-section">
        <div class="chart-container">
            <h2 class="chart-title">
                A Final Look at
                <span id="feature-timeline-title">Acousticness</span>
            </h2>
            <p class="chart-description"></p>
            <div id="feature-timeline-vis" class="chart-space"></div>
        </div>
    </section>

    <!-- Conclusion -->
    <section class="vis-section snap" id="conclusion-section">
        <div class="text-block">
            <h3>Thank You for Reading</h3>
            <p>Created by Avi Walia, Eric Liang, Kevin Hu, Ethan Liu, Taemin Kim</p>
            <p>
                Data Source: Spotify, Kaggle Global Music Charts
            </p>
        </div>
    </section>

</div> <!-- /.pageScroller -->

<section id="spotify-player-section">
    <div id="spotify-player-container" class="chart-space" style="text-align:center; display: none">
        <button id="spotify-hide-btn" class="spotify-hide-btn" aria-label="Hide Spotify player">âœ•</button>
        <iframe
                id="spotify-iframe"
                data-testid="embed-iframe"
                class="spotify-embed"
                src="https://open.spotify.com/embed/track/0VjIjW4GlUZAMYd2vXMi3b?utm_source=generator"
                width="20%" height="152"
                style="border:0;"
                allowfullscreen=""
                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                loading="lazy"
                title="Spotify Player"
                aria-label="Spotify Player">
        </iframe>
    </div>
    <button id="spotify-show-btn" title="Show Spotify player" aria-label="Show Spotify player" style="display:none">â™«</button>
</section>

<!-- JS Scripts -->
<script src="js/spotify_player.js"></script>
<script src="js/vinyl_record.js"></script>
<script src="js/eras.js"></script>
<script src="js/vis_dna_yearly.js"></script>
<script src="js/vis_dna.js"></script>
<script src="js/vis_bubble.js"></script>
<script src="js/scroll_snap.js"></script>
<!--<script src="js/treemap.js"></script>-->
<script src="js/feature_timeline.js"></script>

<script>
    // Provide detailed explanations for each audio feature and expose a global `feature` variable
    var featureDescriptions = {
        danceability: "Measures how suitable a track is for dancing based on tempo, rhythm stability, and beat clarity.",
        energy: "Measures the overall intensity of a track, with higher values corresponding to louder, faster, and more active music.",
        loudness: "The average volume of a track measured in decibels (dB).",
        speechiness: "Measures how much spoken content is present in a track, with higher values indicating more speech-like audio.",
        acousticness: "Measures how strongly a track relies on natural, non-electronic sound sources, with higher values indicating minimal electronic production or synthesized elements.",
        valence: "Indicates how positive or negative a track sounds emotionally, with higher values sounding more upbeat.",
        tempo: "The speed of a track measured in beats per minute (BPM)."
    };

    // Expose a global feature variable and sync it with the dropdown selection.
    // Default to 'energy' (this can be changed if you prefer a different initial feature).
    var feature = 'acousticness';
    const GEO_EMBED_SELECTOR = ".geographical-embed";

    const featureOrder = ['acousticness','danceability','energy','loudness','speechiness','tempo','valence'];

    function updateFeatureDescription(selected) {
        const descEl = document.getElementById('feature-description');
        if (!descEl) return;
        const sel = selected || window.feature || 'acousticness';
        let html = '<div class="feature-list"><dl>';
        featureOrder.forEach((key) => {
            const title = key.charAt(0).toUpperCase() + key.slice(1);
            const body = featureDescriptions[key] || 'No description available.';
            const cls = (key === sel) ? 'selected-feature' : '';
            html += `<dt class="${cls}"><strong>${title}: </strong>${body}</dt>`;
        });
        html += '</dl></div>';
        descEl.innerHTML = html;
    }

    // When the DOM is ready, wire up the selector and set the initial description.
    document.addEventListener('DOMContentLoaded', function() {
        const persistentSelect = document.getElementById('persistent-feature-select');
        if (persistentSelect) {
            // initialize persistent selector to current global feature
            persistentSelect.value = window.feature || 'acousticness';
            // when changed, delegate to existing setGlobalFeature (which also updates descriptions)
            persistentSelect.addEventListener('change', (e) => {
                setGlobalFeature(e.target.value);
                // ensure description highlighting is immediately applied (setGlobalFeature calls updateFeatureDescription,
                // but call again to be safe if overwritten elsewhere)
                updateFeatureDescription(e.target.value);
            });
        }

        // ensure initial rendered description highlights the default
        updateFeatureDescription(window.feature || 'acousticness');
    });

    // Initialize the DNA visualization using the (now-defined) feature variable.
    // The VisDNA instance is created after this script block below in the original file â€” keep that timing.
</script>

<script>
    // expose the instance on window so other scripts (like the top-level feature selector) can call methods on it
    window.dnaVis = new VisDNA("#vis-dna", { height: 360, feature: feature});
    // start is optional; VisDNA will begin animating after data loads. Keep optional start call for compatibility.
    window.dnaVis.start?.();
</script>
<script>
    function setGlobalFeature(f) {
        // 1. update global variable
        window.feature = f;

        // 2. sync all dropdowns
        const top = document.getElementById("feature-select");
        const titleSpan = document.getElementById("feature-timeline-title");
        const dna = document.getElementById("visdna-feature-select");

        if (top) top.value = f;
        if (titleSpan) titleSpan.textContent = f.charAt(0).toUpperCase() + f.slice(1);
        if (dna) dna.value = f;

        // 3. update feature descriptions in main text
        if (typeof updateFeatureDescription === "function") {
            updateFeatureDescription(f);
        }

        // 4. update the timeline
        if (window.featureTimeline) {
            window.featureTimeline.setFeature(f);
        }

        // 5. update the DNA helix
        if (window.dnaVis) {
            window.dnaVis.feature = f;
            window.dnaVis.setColorScales();
            window.dnaVis.updateLegend();
            window.dnaVis.updateDescription();
        }

        // 6. update the title label text
        // Keep the chart title start text intact; the visible feature name is handled by the span above

        // 7. update the universe visualization
        const universeIframe = document.querySelector('.universe-embed');
        if (universeIframe && universeIframe.contentWindow) {
            universeIframe.contentWindow.postMessage({
                type: 'set-feature',
                feature: f
            }, '*');
        }
        syncGeographicalViz();
    }

    function syncGeographicalViz() {
        if (!window.feature) return;
        const iframe = document.querySelector(GEO_EMBED_SELECTOR);
        if (!iframe || !iframe.contentWindow) return;
        iframe.contentWindow.postMessage(
            { type: "global-feature-change", feature: window.feature },
            "*"
        );
    }

    // Listen for requests from the iframe
    window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'get-initial-feature') {
            const universeIframe = document.querySelector('.universe-embed');
            if (universeIframe && universeIframe.contentWindow) {
                universeIframe.contentWindow.postMessage({
                    type: 'set-feature',
                    feature: window.feature // Send the current global feature
                }, '*');
            }
        }
    });
</script>
</body>
</html>
